<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="icon" href="favicon.svg" />
        <title>Handmade Hero</title>
    </head>
    <body>
        <div class="app">
            <header>
                <h1>
                    <img src="favicon.svg" alt="Icon" />
                    Handmade Hero
                </h1>
                <p>Web Version of an Handmade Hero Style Game</p>
                <fieldset>
                    <div class="controls">
                        <label>
                            <input
                                type="checkbox"
                                id="handmadeMute"
                                checked="checked"
                            />
                            Muted
                        </label>
                        <label>
                            Volume:
                            <input
                                type="range"
                                min="0"
                                max="1"
                                step="0.01"
                                id="handmadeAmpl"
                                value="0.1"
                            />
                        </label>
                    </div>
                </fieldset>
            </header>
            <div class="grid" id="handmadeGrid">
                <section>
                    <h2>Canvas</h2>
                    <canvas
                        id="handmadeCanvas"
                        width="800"
                        height="600"
                    ></canvas>
                </section>
                <section>
                    <h2>Log</h2>
                    <pre id="handmadeLog"></pre>
                </section>
            </div>

            <script type="module">
                function log(msg) {
                    if (handmadeLog.childNodes.length > 10) {
                        handmadeLog.removeChild(handmadeLog.firstChild);
                    }
                    handmadeLog.appendChild(
                        document.createTextNode(msg + "\n"),
                    );
                }
                const memory = new WebAssembly.Memory({
                    initial: 32,
                    maximum: 32,
                    shared: true,
                });

                const wasm = await WebAssembly.compileStreaming(
                    fetch("handmade.wasm"),
                );
                const instance = await WebAssembly.instantiate(wasm, {
                    env: {
                        memory,
                    },
                });

                const blockSize = 128;

                const audioCtx = new AudioContext({ samplingRate: 44100 });
                await audioCtx.audioWorklet.addModule("worklet.js");

                const bufferNode = new AudioWorkletNode(
                    audioCtx,
                    "wasm-processor",
                    {
                        processorOptions: { memory, wasm },
                    },
                );
                const volume = audioCtx.createGain();
                const gain = audioCtx.createGain();
                gain.gain.value = handmadeMute.checked ? 0 : 1;
                instance.exports.setup();
                const renderBase = instance.exports.get_render_list();
                console.log(renderBase);

                volume.gain.value = handmadeAmpl.valueAsNumber;
                bufferNode.connect(volume);
                volume.connect(gain);
                gain.connect(audioCtx.destination);

                handmadeMute.addEventListener("input", async (evt) => {
                    await audioCtx.resume();
                    const now = audioCtx.currentTime;
                    const fadeTime = 0.1;
                    handmadeGrid.classList.remove("loading");
                    gain.gain.cancelScheduledValues(now);
                    gain.gain.setValueAtTime(gain.gain.value, now);
                    gain.gain.linearRampToValueAtTime(
                        evt.currentTarget.checked ? 0 : 1,
                        audioCtx.currentTime + fadeTime,
                    );

                    log("Enable Sound");
                });

                function resize() {
                    handmadeCanvas.width =
                        window.devicePixelRatio * handmadeCanvas.clientWidth;
                    handmadeCanvas.height =
                        window.devicePixelRatio * handmadeCanvas.clientHeight;
                    instance.exports.resize_viewport(
                        handmadeCanvas.width,
                        handmadeCanvas.height,
                    );
                    log(handmadeCanvas.width, handmadeCanvas.height);
                }
                window.addEventListener("resize", resize);
                resize();
                const drawCtx = handmadeCanvas.getContext("2d");
                drawCtx.fillStyle = "#fed";
                drawCtx.fillRect(
                    0,
                    0,
                    handmadeCanvas.width,
                    handmadeCanvas.height,
                );
                function draw() {
                    drawCtx.fillStyle = "#fed";
                    const render_list_size =
                        instance.exports.update_and_render();

                    log("render size: " + render_list_size);
                    const render_commands = new Float32Array(
                        memory.buffer,
                        renderBase,
                        render_list_size * 11,
                    );
                    drawCtx.fillStyle = "#fed";
                    drawCtx.fillRect(
                        0,
                        0,
                        handmadeCanvas.width,
                        handmadeCanvas.height,
                    );
                    log("render commands: " + render_commands.length);
                    //  drawCtx.save();
                    //  drawCtx.translate(
                    //      +handmadeCanvas.width / 2,
                    //      +handmadeCanvas.height / 2,
                    //  );
                    //  drawCtx.scale(0.4, 0.4);
                    //  drawCtx.translate(
                    //      -handmadeCanvas.width / 2,
                    //      -handmadeCanvas.height / 2,
                    //  );

                    for (let r = 0; r < render_commands.length; r += 11) {
                        const type = render_commands[r + 0];
                        //console.log("type" + type);
                        switch (type) {
                            case 0:
                                const minX = render_commands[r + 1];
                                const minY = render_commands[r + 2];
                                const maxX = render_commands[r + 3];
                                const maxY = render_commands[r + 4];
                                const colorR = render_commands[r + 5];
                                const colorG = render_commands[r + 6];
                                const colorB = render_commands[r + 7];
                                const colorA = render_commands[r + 8];
                                drawCtx.fillStyle = `rgba(${colorR * 255},${colorG * 255}, ${colorB * 255}, ${colorA})`;
                                drawCtx.fillRect(
                                    Math.min(maxX, minX),
                                    Math.min(maxY, minY),
                                    Math.abs(maxX - minX),
                                    Math.abs(maxY - minY),
                                );
                            //console.log(minX, minY, maxX, maxY);
                        }
                    }
                    drawCtx.restore();
                    requestAnimationFrame(draw);
                }
                requestAnimationFrame(draw);
            </script>
            <style>
                body {
                    font-family: monospace;
                    margin: 0;
                }
                h1 > img {
                    width: 1em;
                    height: 1em;
                    vertical-align: middle;
                    margin: 0;
                }
                h1 {
                    grid-column: 1 / -1;
                    grid-row: 1 / span 1;
                    margin: 0;
                    display: flex;
                    gap: 0.75ex;
                    align-items: center;
                }
                h2 {
                    margin: 0;
                }
                .app {
                    padding: 2em;
                    display: flex;
                    flex-direction: column;
                    gap: 1em;
                }
                .grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(18em, 1fr));
                    grid-template-rows: auto 1fr;
                    gap: 1em;
                    justify-content: stretch;
                    align-items: stretch;
                }
                .loading {
                    opacity: 0.1;
                }
                section {
                    display: flex;
                    flex-direction: column;
                    justify-content: stretch;
                    flex-grow: 1;
                }
                pre {
                    background-color: #111;
                    color: #fff;
                    padding: 1em;
                    margin: 0;
                    flex-grow: 1;
                }
                canvas {
                    background-color: lemonchiffon;
                }
                summary {
                    padding: 1em;
                    cursor: pointer;
                    background-color: #eee;
                    user-select: none;
                }
                .scroller {
                    max-height: 30vh;
                    overflow: auto;
                }
                label {
                    display: flex;
                    align-items: center;
                    gap: 1ex;
                    justify-content: end;
                    justify-self: end;
                    background-color: #eee;
                    padding: 0 1em 0 1ex;
                    user-select: none;
                }
                button {
                    background-color: #111;
                    color: #fff;
                    border: none;
                    border-radius: 4px;
                    padding: 1ex;
                    font: inherit;
                    cursor: pointer;
                }
                button:hover {
                    background-color: #333;
                }

                button:active {
                    background-color: #000;
                    color: #eee;
                }
                input[type="range"] {
                    padding: 1ex 0;
                    margin: 0;
                }
                fieldset {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1ex;
                    padding: 0;
                    border: none;
                }
                .controls {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1em;
                    justify-content: end;
                }
            </style>
        </div>
    </body>
</html>
